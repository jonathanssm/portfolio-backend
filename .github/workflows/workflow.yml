name: Deploy Backend to VM

on:
  push:
    branches:
      - main
      - develop
      - feature/*

env:
  VM_HOST: ${{ secrets.BACKEND_VM_IP }}
  VM_USER: ${{ secrets.BACKEND_VM_USER }}
  VM_SSH_KEY: ${{ secrets.BACKEND_VM_SSH_KEY }}
  VM_PATH: /home/ubuntu/backend
  JAR_NAME: portfolio-backend-0.0.1-SNAPSHOT.jar

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Java and Cache
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'maven'

      - name: Build JAR with verification
        run: |
          chmod +x ./mvnw
          ./mvnw -B clean package -DskipTests -T 1C
          
          # ‚úÖ Verifica√ß√£o robusta do JAR
          echo "Verifying JAR file..."
          if [ ! -f "target/$JAR_NAME" ]; then
            echo "‚ùå JAR file not found in target/"
            ls -la target/
            exit 1
          fi
          
          if [ ! -s "target/$JAR_NAME" ]; then
            echo "‚ùå JAR file is empty"
            ls -lh target/
            exit 1
          fi
          
          # ‚úÖ Testa se √© um arquivo v√°lido
          if file "target/$JAR_NAME" | grep -q "Java archive"; then
            echo "‚úÖ JAR file is valid"
          else
            echo "‚ùå JAR file is not a valid Java archive"
            file "target/$JAR_NAME"
            exit 1
          fi

      - name: Prepare artifacts with checksum
        run: |
          # ‚úÖ Copia e verifica integridade
          cp target/$JAR_NAME .
          ls -la $JAR_NAME Dockerfile
          
          # ‚úÖ Checksum para verifica√ß√£o
          md5sum $JAR_NAME > jar_checksum.txt
          echo "JAR checksum: $(md5sum $JAR_NAME)"

      - name: Setup VM directory
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ env.VM_HOST }}
          username: ${{ env.VM_USER }}
          key: ${{ env.VM_SSH_KEY }}
          script: |
            mkdir -p ${{ env.VM_PATH }}
            cd ${{ env.VM_PATH }}
            # ‚úÖ Limpa arquivos e diret√≥rios anteriores completamente
            rm -rf *.jar Dockerfile 2>/dev/null || true
            echo "VM directory cleaned and ready"

      - name: Copy artifacts to VM
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ env.VM_HOST }}
          username: ${{ env.VM_USER }}
          key: ${{ env.VM_SSH_KEY }}
          source: "${{ env.JAR_NAME }},Dockerfile"
          target: ${{ env.VM_PATH }}
          overwrite: true

      - name: Verify artifacts on VM
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ env.VM_HOST }}
          username: ${{ env.VM_USER }}
          key: ${{ env.VM_SSH_KEY }}
          script: |
            set -e
            cd ${{ env.VM_PATH }}
            
            echo "üì¶ Verifying artifacts on VM..."
            ls -la
            
            # ‚úÖ Verifica se os arquivos s√£o v√°lidos
            if [ ! -f "${{ env.JAR_NAME }}" ]; then
              echo "‚ùå JAR not found on VM"
              exit 1
            fi
            
            if [ ! -s "${{ env.JAR_NAME }}" ]; then
              echo "‚ùå JAR is empty on VM"
              exit 1
            fi
            
            echo "‚úÖ All artifacts verified successfully"

      - name: Deploy Docker container
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ env.VM_HOST }}
          username: ${{ env.VM_USER }}
          key: ${{ env.VM_SSH_KEY }}
          script: |
            set -e
            cd ${{ env.VM_PATH }}

            # üè∑Ô∏è Determina ambiente pela branch
            BRANCH="${GITHUB_REF##*/}"
            case "$BRANCH" in
              "main") ENV="prod" ;;
              "develop") ENV="staging" ;;
              *) ENV="dev" ;;
            esac

            IMAGE_NAME="portfolio-backend-$ENV"
            CONTAINER_NAME="portfolio-backend-$ENV"
            echo "üöÄ Deploying to $ENV environment"

            # üê≥ Verifica Docker
            if ! command -v docker &> /dev/null; then
              echo "üì¶ Installing Docker..."
              curl -fsSL https://get.docker.com   | sudo sh
              sudo systemctl enable docker
            fi

            # üèóÔ∏è Build da imagem
            echo "üî® Building Docker image..."
            sudo docker build -t $IMAGE_NAME .

            # üîÑ Rolling update
            echo "üîÑ Performing rolling update"

            # ‚úÖ PARTE CR√çTICA: Remove o container do ambiente ATUAL se existir (para liberar porta)
            echo "üßπ Stopping and removing current environment container (if exists): $CONTAINER_NAME"
            sudo docker stop $CONTAINER_NAME 2>/dev/null || true
            sudo docker rm $CONTAINER_NAME 2>/dev/null || true

            # ‚úÖ PARTE MAIS CR√çTICA: Remove containers de OUTROS ambientes para garantir a porta 8080
            echo "üßπ Aggressively stopping and removing containers from OTHER environments to free port 8080..."
            for other_env in dev staging prod; do
              if [ "$other_env" != "$ENV" ]; then
                echo "  ‚Üí Targeting: portfolio-backend-$other_env"
                # Para o container (ignora erro se n√£o existir)
                sudo docker stop "portfolio-backend-$other_env" 2>/dev/null || true
                # Remove o container (ignora erro se n√£o existir)
                sudo docker rm "portfolio-backend-$other_env" 2>/dev/null || true
              fi
            done

            # üöÄ Executa container
            echo "üéØ Starting NEW container: $CONTAINER_NAME"
            sudo docker run -d \
              --name $CONTAINER_NAME \
              -p 8080:8080 \
              -e SPRING_PROFILES_ACTIVE=$ENV \
              -e SPRING_DATASOURCE_URL="${{ secrets.SPRING_DATASOURCE_URL }}" \
              -e SPRING_DATASOURCE_USERNAME="${{ secrets.SPRING_DATASOURCE_USERNAME }}" \
              -e SPRING_DATASOURCE_PASSWORD="${{ secrets.SPRING_DATASOURCE_PASSWORD }}" \
              -e SPRING_KAFKA_BOOTSTRAP_SERVERS="${{ secrets.SPRING_KAFKA_BOOTSTRAP_SERVERS }}" \
              --restart unless-stopped \
              $IMAGE_NAME

            # üîç Verifica√ß√£o P√≥s-Deploy: Confirma que o container correto est√° rodando
            echo "‚úÖ Deployment completed! Verifying container status..."
            sleep 5 # D√° tempo para o container iniciar

            # Lista todos os containers ativos
            echo "üìã Currently running containers:"
            sudo docker ps --format "table {{.ID}}\t{{.Names}}\t{{.Status}}\t{{.Ports}}"

            # Verifica se o container esperado est√° na lista
            if sudo docker ps --format '{{.Names}}' | grep -q "^$CONTAINER_NAME$"; then
              echo "üíö SUCCESS: Container '$CONTAINER_NAME' is running and healthy!"
              echo "üìã Application Logs (last 15 lines):"
              sudo docker logs --tail 15 $CONTAINER_NAME
            else
              echo "üíî CRITICAL ERROR: Container '$CONTAINER_NAME' is NOT running!"
              echo "üìã Checking logs for any container that might have failed..."
              # Lista containers que sa√≠ram (exited) recentemente
              sudo docker ps -a --filter "status=exited" --format "table {{.Names}}\t{{.Status}}\t{{.Command}}" --last 5
              echo "üìã Logs from the expected container (if it exists):"
              sudo
